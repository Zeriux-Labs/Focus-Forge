<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab Error Handling Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 8px 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #3367d6;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Tab Error Handling Test</h1>
    
    <div class="test-section">
        <h2>Test Scenario: Tab No Longer Exists</h2>
        <p>This test simulates the error "Error: No tab with id" by attempting to access a non-existent tab ID.</p>
        <button id="testNonExistentTab">Test Non-Existent Tab</button>
        <button id="clearLog">Clear Log</button>
        <div class="log" id="logOutput"></div>
    </div>

    <div class="test-section">
        <h2>Improved Error Handling Code</h2>
        <p>The following improvements were made to handle tab-related errors:</p>
        <ol>
            <li>Added try-catch block in <code>saveCurrentTabTime</code> function</li>
            <li>Added try-catch block in <code>switchActiveTab</code> function</li>
            <li>Added error handling in tab event listeners</li>
            <li>Added tab removal handler to clean up when tabs are closed</li>
            <li>Added error handling in window focus change event listener</li>
        </ol>
    </div>

    <script>
        // Mock chrome API for testing
        const chrome = {
            tabs: {
                get: function(tabId) {
                    return new Promise((resolve, reject) => {
                        // Simulate error for non-existent tab
                        if (tabId === 1389708522 || tabId === 9999) {
                            reject(new Error(`No tab with id: ${tabId}`));
                        } else {
                            resolve({
                                id: tabId,
                                url: 'https://example.com',
                                active: true
                            });
                        }
                    });
                }
            },
            storage: {
                local: {
                    get: () => Promise.resolve({}),
                    set: () => Promise.resolve()
                }
            }
        };

        // Mock current active tab
        let currentActive = {
            tabId: 1234,
            url: 'https://example.com',
            startTime: Date.now()
        };

        // Mock usage data
        let usageData = {};

        // Implementation of saveCurrentTabTime with improved error handling
        async function saveCurrentTabTime() {
            if (!currentActive.tabId || !currentActive.url || !currentActive.startTime) {
                return;
            }

            try {
                // Try to get the tab information
                let tab;
                try {
                    tab = await chrome.tabs.get(currentActive.tabId);
                } catch (tabError) {
                    // Tab no longer exists, log and reset current active
                    log(`Error saving tab time: ${tabError.message}`);
                    log(`Resetting tracking for non-existent tab ${currentActive.tabId}`);
                    currentActive = { tabId: null, url: null, startTime: null };
                    return;
                }

                // Calculate time spent
                const timeSpent = Math.floor((Date.now() - currentActive.startTime) / 1000);
                log(`Saved ${timeSpent} seconds for tab ${currentActive.tabId}`);

                // Rest of the function would update usage data
            } catch (error) {
                log(`General error in saveCurrentTabTime: ${error.message}`);
                // Reset tracking on any error
                currentActive = { tabId: null, url: null, startTime: null };
            }
        }

        // Test function to simulate the error
        async function testNonExistentTab() {
            log('Starting test for non-existent tab...');
            
            // Set current active to a non-existent tab ID
            currentActive = {
                tabId: 1389708522, // This is the tab ID from the error message
                url: 'https://example.com',
                startTime: Date.now() - 60000 // 1 minute ago
            };
            
            log(`Set current active tab to ID: ${currentActive.tabId}`);
            
            try {
                await saveCurrentTabTime();
                log('saveCurrentTabTime completed');
            } catch (error) {
                log(`Uncaught error: ${error.message}`);
            }
            
            log(`Current active tab after test: ${JSON.stringify(currentActive)}`);
        }

        // Utility function to log to the UI
        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Event listeners
        document.getElementById('testNonExistentTab').addEventListener('click', testNonExistentTab);
        document.getElementById('clearLog').addEventListener('click', () => {
            document.getElementById('logOutput').innerHTML = '';
        });

        // Initial log
        log('Test page loaded. Click the button to test error handling.');
    </script>
</body>
</html>